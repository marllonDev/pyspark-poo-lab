# Projeto PySpark - Relat√≥rio de Pedidos com Pagamentos Recusados

## Descri√ß√£o
Este projeto PySpark gera um relat√≥rio de pedidos de venda com pagamentos recusados e classificados como leg√≠timos, para o ano de 2025.

## Funcionalidades
- Filtra pedidos com pagamentos recusados (`status=false`) e leg√≠timos (`fraude=false`)
- Processa apenas pedidos do ano de 2025
- Ordena por estado, forma de pagamento e data
- Gera relat√≥rio em formato Parquet

## Estrutura do Projeto
```
pyspark-poo-lab/
‚îú‚îÄ‚îÄ src/                    # C√≥digo fonte
‚îÇ   ‚îú‚îÄ‚îÄ config/            # Configura√ß√µes
‚îÇ   ‚îú‚îÄ‚îÄ session/           # Gerenciamento de sess√£o Spark
‚îÇ   ‚îú‚îÄ‚îÄ data_io/           # Leitura e escrita de dados
‚îÇ   ‚îú‚îÄ‚îÄ business/         # L√≥gica de neg√≥cio
‚îÇ   ‚îú‚îÄ‚îÄ orchestration/    # Orquestra√ß√£o do pipeline
‚îÇ   ‚îî‚îÄ‚îÄ main.py          # Ponto de entrada
‚îú‚îÄ‚îÄ tests/                # Testes unit√°rios
‚îú‚îÄ‚îÄ data/                 # Dados de entrada e sa√≠da
‚îÇ   ‚îú‚îÄ‚îÄ input/            # Dados de entrada
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pagamentos/   # Arquivos JSON de pagamentos
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ pedidos/      # Arquivos CSV de pedidos
‚îÇ   ‚îî‚îÄ‚îÄ output/           # Dados de sa√≠da
‚îú‚îÄ‚îÄ venv/                 # Ambiente virtual
‚îú‚îÄ‚îÄ pyproject.toml        # Configura√ß√£o do projeto
‚îú‚îÄ‚îÄ requirements.txt      # Depend√™ncias
‚îî‚îÄ‚îÄ README.md            # Documenta√ß√£o
```

## Pr√©-requisitos
- Python 3.8+
- PySpark 3.4+
- Java 8+

## Instala√ß√£o
```bash
# 1. Ativar o ambiente virtual
source venv/bin/activate

# 2. Instalar depend√™ncias (se necess√°rio)
pip install -r requirements.txt
```

## Execu√ß√£o
```bash
# Executar o pipeline completo
source venv/bin/activate
python src/main.py
```

## Testes
```bash
# Executar testes unit√°rios
source venv/bin/activate
python -m pytest tests/test_order_processor.py -v
```

## Configura√ß√£o
As configura√ß√µes do Spark podem ser ajustadas em `src/config/spark_config.py`.

## Estrutura dos Dados

> **üìã Nota**: Os datasets j√° est√£o inclu√≠dos no reposit√≥rio em `data/input/`. N√£o √© necess√°rio baix√°-los separadamente.

### Dataset de Pagamentos
- **Formato**: JSON comprimido (*.json.gz)
- **Caminho**: `data/input/pagamentos/`
- **Schema**: 
  - `id_pedido` (string): Identificador do pedido
  - `forma_pagamento` (string): Forma de pagamento utilizada
  - `valor_pagamento` (double): Valor do pagamento
  - `status` (boolean): Status do pagamento (true=aprovado, false=recusado)
  - `data_processamento` (string): Data de processamento do pagamento
  - `avaliacao_fraude` (object): Objeto contendo:
    - `fraude` (boolean): Indicador de fraude (true=fraudulento, false=leg√≠timo)
    - `score` (double): Score de risco de fraude

### Dataset de Pedidos
- **Formato**: CSV comprimido (*.csv.gz)
- **Caminho**: `data/input/pedidos/`
- **Schema**:
  - `ID_PEDIDO` (string): Identificador √∫nico do pedido
  - `PRODUTO` (string): Nome do produto
  - `VALOR_UNITARIO` (string): Valor unit√°rio do produto
  - `QUANTIDADE` (string): Quantidade do produto
  - `DATA_CRIACAO` (string): Data de cria√ß√£o do pedido
  - `UF` (string): Estado onde foi realizado o pedido
  - `ID_CLIENTE` (string): Identificador do cliente

## Sa√≠da
O relat√≥rio √© gerado em formato Parquet no diret√≥rio `data/output/relatorio_pedidos/`:
- **Schema de Sa√≠da**:
  - `id_pedido` (string): Identificador do pedido
  - `estado` (string): Estado (UF) onde o pedido foi feito
  - `forma_pagamento` (string): Forma de pagamento
  - `valor_total` (double): Valor total do pedido (VALOR_UNITARIO √ó QUANTIDADE)
  - `data_pedido` (timestamp): Data do pedido

### Filtros Aplicados
- ‚úÖ Pedidos com pagamentos recusados (`status = false`)
- ‚úÖ Pedidos classificados como leg√≠timos (`avaliacao_fraude.fraude = false`)
- ‚úÖ Apenas pedidos do ano de 2025
- ‚úÖ Ordena√ß√£o: estado ‚Üí forma_pagamento ‚Üí data_pedido

## Status do Projeto

### ‚úÖ Testes Realizados
- **Testes Unit√°rios**: ‚úÖ PASSOU - Todas as funcionalidades da classe `OrderProcessor` testadas
- **Pipeline Completo**: ‚úÖ PASSOU - Pipeline executado com sucesso nos dados reais
- **Verifica√ß√£o de Linting**: ‚úÖ PASSOU - Nenhum erro de linting encontrado
- **Estrutura de Dados**: ‚úÖ PASSOU - Schema de sa√≠da conforme especifica√ß√£o

### üìä Resultados da √öltima Execu√ß√£o
- **Total de registros processados**: 540 pedidos
- **Filtros aplicados**: Pagamentos recusados e leg√≠timos do ano 2025
- **Arquivo de sa√≠da**: `data/output/relatorio_pedidos/part-*.parquet`
- **Status**: ‚úÖ Pipeline executado com sucesso

### üîß Arquitetura Implementada
- ‚úÖ **Orienta√ß√£o a Objetos**: Todas as classes implementadas
- ‚úÖ **Inje√ß√£o de Depend√™ncias**: Configurada no `main.py`
- ‚úÖ **Configura√ß√µes Centralizadas**: `SparkConfig`
- ‚úÖ **Gerenciamento de Sess√£o**: `SparkSessionManager`
- ‚úÖ **Separa√ß√£o de Responsabilidades**: Reader, Writer, Processor, Orchestrator
- ‚úÖ **Logging**: Configurado em todas as classes
- ‚úÖ **Tratamento de Erros**: Try/catch implementado
- ‚úÖ **Empacotamento**: pyproject.toml, requirements.txt, MANIFEST.in

## Troubleshooting

### ‚ö†Ô∏è Problemas Comuns

1. **Erro de Permiss√£o do Python**: 
   ```bash
   source venv/bin/activate
   ```

2. **Paths Incorretos**: 
   - Execute sempre a partir do diret√≥rio raiz do projeto
   - Verifique se est√° na pasta `pyspark-poo-lab/`

3. **Depend√™ncias Faltando**:
   ```bash
   # Instalar Java 8+ para PySpark
   java -version
   
   # Reinstalar depend√™ncias Python
   pip install -r requirements.txt
   ```

4. **Erro "PATH_NOT_FOUND"**: 
   - Verifique se voc√™ est√° no diret√≥rio correto do projeto
   - Os datasets j√° est√£o inclu√≠dos no reposit√≥rio em `data/input/`

## Autor
[Seu Nome] - [Seu RM]

## Licen√ßa
Este projeto est√° sob a licen√ßa MIT.
